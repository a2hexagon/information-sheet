<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Digital Presence | Client Onboarding</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- PWA Manifest & Theme -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Digital Presence">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <!-- External Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap');
    body {
      background-color: #f8fafc;
      font-family: 'Inter', sans-serif;
      overscroll-behavior-y: contain;
    }
    .step { display: none; }
    .step.active { display: block; animation: stepReveal 0.5s cubic-bezier(0.16, 1, 0.3, 1);}
    @keyframes stepReveal { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .field-group.invalid input, .field-group.invalid select, .field-group.invalid textarea {
      border-color: #ef4444; background-color: #fef2f2;
    }
    .loading-spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid #ffffff;
      border-radius: 50%;
      width: 20px; height: 20px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #pdf-container { position: absolute; width: 100%; height: 0; overflow: hidden; pointer-events: none; }
    #receipt-pdf-template { width: 800px; background: #fff; padding: 60px; color: #0f172a; }
  </style>
</head>
<body class="safe-top safe-bottom">

  <div class="min-h-screen flex flex-col items-center justify-center p-4">
    <div class="w-full max-w-xl bg-white shadow-2xl rounded-[2.5rem] overflow-hidden border border-slate-200 flex flex-col">

      <!-- Progress Header -->
      <div class="bg-slate-900 p-8 text-white">
        <div class="flex justify-between items-start mb-6">
          <div>
            <h1 class="text-2xl font-black">Onboarding</h1>
            <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em]">Client Portal</p>
          </div>
          <div class="text-right">
            <span id="percent-label" class="text-3xl font-black text-sky-500">14%</span>
          </div>
        </div>
        <div class="w-full bg-slate-800 rounded-full h-2 overflow-hidden">
          <div id="progress-bar" class="bg-sky-500 h-full w-[14%] transition-all duration-700 ease-in-out"></div>
        </div>
      </div>

      <!-- Multi-Step Form -->
      <form id="pwaForm" name="client-onboarding" netlify netlify-honeypot="bot-field" method="POST" class="p-8 md:p-12 flex-grow overflow-y-auto max-h-[70vh]">
        <input type="hidden" name="form-name" value="client-onboarding" />
        <div style="display: none;">
          <label>Don't fill this out if you're human: <input name="bot-field" /></label>
        </div>

        <!-- STEP 1: Business -->
        <div class="step active" data-step="1">
          <h2 class="text-xl font-black text-slate-800 mb-8 uppercase tracking-tight">Business Profile</h2>
          <div class="space-y-6">
            <div class="field-group">
              <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Company Name *</label>
              <input type="text" id="business_name" required placeholder="Legal Entity Name" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-sky-500 focus:bg-white transition-all">
            </div>
            <div class="field-group">
              <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Industry *</label>
              <input type="text" id="industry" required placeholder="e.g. Retail, Tech, NGO" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-sky-500 focus:bg-white transition-all">
            </div>
          </div>
          <div class="mt-12 flex justify-end">
            <button type="button" onclick="validateStep()" class="bg-slate-900 text-white px-10 py-4 rounded-2xl font-black uppercase text-xs tracking-widest shadow-xl active:scale-95 transition-transform">Next Step</button>
          </div>
        </div>

        <!-- STEP 2: Contact Person -->
        <div class="step" data-step="2">
          <h2 class="text-xl font-black text-slate-800 mb-8 uppercase tracking-tight">Contact Person</h2>
          <div class="space-y-6">
            <div class="field-group">
              <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Full Name *</label>
              <input type="text" id="contact_person" required class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-sky-500">
            </div>
            <div class="field-group">
              <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Phone Number *</label>
              <input type="tel" id="phone" required placeholder="+880" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-sky-500">
            </div>
          </div>
          <div class="mt-12 flex justify-between">
            <button type="button" onclick="changeStep(-1)" class="text-slate-400 font-black uppercase text-xs">Back</button>
            <button type="button" onclick="validateStep()" class="bg-slate-900 text-white px-10 py-4 rounded-2xl font-black uppercase text-xs tracking-widest">Next Step</button>
          </div>
        </div>

        <!-- STEP 3: Location -->
        <div class="step" data-step="3">
          <h2 class="text-xl font-black text-slate-800 mb-8 uppercase tracking-tight">Office Address</h2>
          <div class="space-y-6">
            <button type="button" onclick="getUserLocation()" id="geoBtn" class="w-full py-4 border-2 border-dashed border-sky-200 text-sky-600 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-sky-50 transition-all flex items-center justify-center gap-2">
              üìç Click for Geo-Auto Fill
            </button>
            <div class="field-group">
              <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Detailed Address *</label>
              <textarea id="address" required rows="4" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-sky-500"></textarea>
            </div>
          </div>
          <div class="mt-12 flex justify-between">
            <button type="button" onclick="changeStep(-1)" class="text-slate-400 font-black uppercase text-xs">Back</button>
            <button type="button" onclick="validateStep()" class="bg-slate-900 text-white px-10 py-4 rounded-2xl font-black uppercase text-xs tracking-widest">Next Step</button>
          </div>
        </div>

        <!-- STEP 4: Brand Identity -->
        <div class="step" data-step="4">
          <h2 class="text-xl font-black text-slate-800 mb-8 uppercase tracking-tight">Identity</h2>
          <div class="space-y-6">
            <div class="field-group">
              <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Brand Logo</label>
              <input type="file" id="logo" accept="image/*" class="w-full text-xs file:bg-slate-100 file:border-0 file:rounded-xl file:px-4 file:py-2 file:mr-4 file:font-black">
            </div>
            <div class="field-group">
              <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Hex Color Code</label>
              <input type="text" id="color" placeholder="#000000" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-sky-500">
            </div>
          </div>
          <div class="mt-12 flex justify-between">
            <button type="button" onclick="changeStep(-1)" class="text-slate-400 font-black uppercase text-xs">Back</button>
            <button type="button" onclick="changeStep(1)" class="bg-slate-900 text-white px-10 py-4 rounded-2xl font-black uppercase text-xs tracking-widest">Next Step</button>
          </div>
        </div>

        <!-- STEP 5: Digital Links -->
        <div class="step" data-step="5">
          <h2 class="text-xl font-black text-slate-800 mb-8 uppercase tracking-tight">Digital Presence</h2>
          <div class="space-y-6">
            <div class="field-group">
              <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Website URL</label>
              <input type="url" id="website" placeholder="https://..." class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 outline-none">
            </div>
            <div class="field-group">
              <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Facebook Page</label>
              <input type="url" id="fb" placeholder="https://facebook.com/..." class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 outline-none">
            </div>
          </div>
          <div class="mt-12 flex justify-between">
            <button type="button" onclick="changeStep(-1)" class="text-slate-400 font-black uppercase text-xs">Back</button>
            <button type="button" onclick="changeStep(1)" class="bg-slate-900 text-white px-10 py-4 rounded-2xl font-black uppercase text-xs tracking-widest">Next Step</button>
          </div>
        </div>

        <!-- STEP 6: Payment -->
        <div class="step" data-step="6">
          <h2 class="text-xl font-black text-slate-800 mb-8 uppercase tracking-tight">Billing & Verification</h2>
          <div class="space-y-6">
            <div class="field-group">
              <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Method *</label>
              <select id="paymentMethod" onchange="toggleMfsUI()" required class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 outline-none">
                <option value="">Select Method</option>
                <option value="bkash">bKash</option>
                <option value="nagad">Nagad</option>
                <option value="rocket">Rocket</option>
                <option value="bank">Bank Transfer</option>
              </select>
            </div>
            
            <div id="mfs-container" class="hidden animate-pulse">
              <div class="bg-slate-900 text-white p-6 rounded-3xl mb-4">
                <p id="mfs-label" class="text-[8px] font-black uppercase tracking-widest text-slate-400 mb-1">bKash Personal</p>
                <p class="text-xl font-black">+8801905417596</p>
              </div>
              <div class="field-group">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Transaction ID (TrxID) *</label>
                <input type="text" id="trxId" placeholder="Enter ID from SMS" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-sky-500 uppercase font-bold">
              </div>
            </div>
          </div>
          <div class="mt-12 flex justify-between">
            <button type="button" onclick="changeStep(-1)" class="text-slate-400 font-black uppercase text-xs">Back</button>
            <button type="button" onclick="validateStep()" class="bg-slate-900 text-white px-10 py-4 rounded-2xl font-black uppercase text-xs tracking-widest">Next Step</button>
          </div>
        </div>

        <!-- STEP 7: Final -->
        <div class="step" data-step="7">
          <h2 class="text-xl font-black text-slate-800 mb-8 uppercase tracking-tight">Confirm Submission</h2>
          <div class="p-6 bg-emerald-50 rounded-3xl border border-emerald-100 mb-8">
            <p class="text-xs font-bold text-emerald-800">Ready to proceed?</p>
            <p class="text-[10px] text-emerald-600 mt-1">By submitting, you agree to our service terms. A PDF receipt will be generated automatically.</p>
          </div>
          <div class="mt-12 flex justify-between items-center">
            <button type="button" onclick="changeStep(-1)" class="text-slate-400 font-black uppercase text-xs">Back</button>
            <button type="submit" id="finalSubmit" class="bg-sky-500 text-white px-12 py-5 rounded-[2rem] font-black uppercase text-xs tracking-widest shadow-2xl hover:bg-sky-600 active:scale-95 transition-all flex items-center gap-2">
              Submit & Download
            </button>
          </div>
        </div>

      </form>
    </div>
  </div>

  <!-- PDF Template & Scripts -->
  <div id="pdf-container">
    <div id="receipt-pdf-template">
      <div style="border-bottom: 5px solid #0f172a; padding-bottom: 20px; margin-bottom: 40px; display: flex; justify-content: space-between; align-items: flex-end;">
        <div>
          <h1 style="margin: 0; font-size: 32px; font-weight: 900; letter-spacing: -1px; font-family: sans-serif;">DIGITAL PRESENCE</h1>
          <p style="margin: 5px 0 0; color: #64748b; font-size: 14px; font-weight: 600; font-family: sans-serif;">ONBOARDING VERIFICATION</p>
        </div>
        <div style="text-align: right; font-family: sans-serif;">
          <p id="pdf-date" style="margin: 0; font-size: 12px; font-weight: 800;"></p>
          <p style="margin: 0; color: #94a3b8; font-size: 10px;">ID: DP-PWA-2024</p>
        </div>
      </div>
      <div style="margin-bottom: 40px; font-family: sans-serif;">
        <h3 style="font-size: 12px; color: #0ea5e9; text-transform: uppercase; margin-bottom: 15px;">Client Information</h3>
        <table style="width: 100%; font-size: 14px;">
          <tr><td style="color: #94a3b8; width: 30%;">Business:</td><td id="pdf-biz" style="font-weight: 800;"></td></tr>
          <tr><td style="color: #94a3b8;">Person:</td><td id="pdf-contact" style="font-weight: 800;"></td></tr>
          <tr><td style="color: #94a3b8;">Phone:</td><td id="pdf-phone" style="font-weight: 800;"></td></tr>
        </table>
      </div>
      <div style="background: #f8fafc; border-radius: 20px; padding: 30px; border: 1px solid #e2e8f0; font-family: sans-serif;">
        <h3 style="font-size: 12px; color: #0ea5e9; text-transform: uppercase; margin-bottom: 10px;">Payment Status</h3>
        <table style="width: 100%; font-size: 14px;">
          <tr><td style="color: #94a3b8;">Method:</td><td id="pdf-method" style="font-weight: 800; text-transform: uppercase;"></td></tr>
          <tr><td style="color: #94a3b8;">Trx ID:</td><td id="pdf-trx" style="font-weight: 800;"></td></tr>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // PWA Service Worker
    // ==========================
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/service-worker.js")
          .then(() => console.log("Service Worker Registered"))
          .catch(err => console.error("SW failed", err));
      });
    }

    // ==========================
    // Multi-step Form Logic
    // ==========================
    const steps = document.querySelectorAll(".step");
    const progressBar = document.getElementById("progress-bar");
    const percentLabel = document.getElementById("percent-label");
    let currentStep = 0;

    function showStep(index) {
      steps.forEach((s,i)=>s.classList.toggle("active",i===index));
      const pct = Math.round(((index+1)/steps.length)*100);
      progressBar.style.width = pct+"%";
      percentLabel.textContent = pct+"%";
    }

    function changeStep(dir) {
      currentStep += dir;
      if(currentStep<0) currentStep=0;
      if(currentStep>=steps.length) currentStep=steps.length-1;
      showStep(currentStep);
    }

    function validateStep() {
      const stepEl = steps[currentStep];
      const requiredFields = stepEl.querySelectorAll("[required]");
      let valid = true;
      requiredFields.forEach(f=>{
        if(!f.value.trim()){ valid=false; f.parentElement.classList.add("invalid"); }
        else { f.parentElement.classList.remove("invalid"); }
      });
      if(valid) changeStep(1);
    }

    // ==========================
    // Payment Toggle
    // ==========================
    function toggleMfsUI(){
      const method = document.getElementById("paymentMethod").value;
      const container = document.getElementById("mfs-container");
      const label = document.getElementById("mfs-label");
      if(method && method!=="bank"){
        container.classList.remove("hidden");
        label.textContent = method+" Personal";
      } else container.classList.add("hidden");
    }

    // ==========================
    // Geolocation
    // ==========================
    function getUserLocation(){
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          const lat = pos.coords.latitude.toFixed(6);
          const lng = pos.coords.longitude.toFixed(6);
          document.getElementById("address").value = `https://www.google.com/maps?q=${lat},${lng}`;
        }, err=>alert("Unable to fetch location"));
      } else alert("Geolocation not supported");
    }

    // ==========================
    // Form Submission with Netlify
    // ==========================
    const form = document.getElementById("pwaForm");
    form.addEventListener("submit", async e=>{
      e.preventDefault();

      // Fill PDF template first
      document.getElementById("pdf-biz").textContent = document.getElementById("business_name").value;
      document.getElementById("pdf-contact").textContent = document.getElementById("contact_person").value;
      document.getElementById("pdf-phone").textContent = document.getElementById("phone").value;
      document.getElementById("pdf-method").textContent = document.getElementById("paymentMethod").value;
      document.getElementById("pdf-trx").textContent = document.getElementById("trxId").value || "N/A";
      document.getElementById("pdf-date").textContent = new Date().toLocaleString();

      // Generate PDF
      const element = document.getElementById("receipt-pdf-template");
      html2pdf().from(element).save("DigitalPresence-Receipt.pdf");

      // Submit to Netlify if online
      if (navigator.onLine) {
        try {
          const formData = new FormData(form);
          const response = await fetch('/', {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            alert("Form submitted successfully and PDF generated! Thank you.");
          } else {
            alert("PDF generated! Form submission may have failed - please check your connection.");
          }
        } catch (error) {
          console.error('Form submission error:', error);
          alert("PDF generated! Form submission failed - please try again when online.");
        }
      } else {
        alert("PDF generated! Form will be submitted when you're back online.");
      }

      // Reset form
      form.reset(); currentStep=0; showStep(0);
    });

    showStep(0);
  </script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('SW registered: ', registration);
          })
          .catch(registrationError => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }

    // Offline detection
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);

    function updateOnlineStatus() {
      const status = document.getElementById('online-status');
      if (navigator.onLine) {
        status.style.display = 'none';
      } else {
        status.style.display = 'block';
      }
    }
  </script>

  <!-- Offline Status Banner -->
  <div id="online-status" class="fixed top-0 left-0 right-0 bg-red-500 text-white text-center py-2 z-50" style="display: none;">
    You are currently offline. Some features may not be available.
  </div>
</body>
</html>
